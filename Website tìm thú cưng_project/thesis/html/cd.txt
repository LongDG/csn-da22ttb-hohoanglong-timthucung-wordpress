
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

// Đảm bảo các file cần thiết được bao gồm
require_once(ABSPATH . 'wp-admin/includes/media.php');
require_once(ABSPATH . 'wp-admin/includes/image.php');
require_once(ABSPATH . 'wp-admin/includes/file.php');

// Hàm xử lý form đăng bài viết
function handle_post_submission() {
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['submit_post'])) {

        // Kiểm tra người dùng có đăng nhập không
        if (!is_user_logged_in()) {
            $_SESSION['post_error'] = "Bạn cần đăng nhập để gửi bài viết.";
            return;
        }

        // Lấy dữ liệu từ form và làm sạch
        $post_title       = sanitize_text_field($_POST['post_title']);
        $post_description = sanitize_textarea_field($_POST['post_description']);
        $post_category    = sanitize_text_field($_POST['post_category']); // Danh mục bài viết
        $featured_image   = $_FILES['featured_image'];

        // Kiểm tra dữ liệu bắt buộc
        if (empty($post_title) || empty($post_description) || empty($post_category)) {
            $_SESSION['post_error'] = "Vui lòng nhập đầy đủ thông tin!";
            return;
        }

        // Lấy ID của danh mục dựa vào slug
        $category_obj = get_category_by_slug($post_category);
        if (!$category_obj) {
            $_SESSION['post_error'] = "Danh mục không hợp lệ!";
            return;
        }
        $category_id = $category_obj->term_id;

        // Tạo bài viết mới
        $new_post = array(
            'post_title'    => $post_title,
            'post_content'  => $post_description,
            'post_status'   => 'pending', // Bài viết sẽ ở trạng thái chờ duyệt
            'post_category' => array($category_id),
            'post_type'     => 'post',
        );

        // Thêm bài viết vào WordPress
        $post_id = wp_insert_post($new_post);

        // Kiểm tra nếu bài viết được tạo thành công
        if ($post_id && !is_wp_error($post_id)) {
            // Xử lý ảnh đại diện nếu có
            if (!empty($featured_image) && $featured_image['size'] > 0) {
                $attachment_id = media_handle_upload('featured_image', $post_id);

                if (is_wp_error($attachment_id)) {
                    $_SESSION['post_error'] = "Lỗi khi tải ảnh: " . $attachment_id->get_error_message();
                } else {
                    set_post_thumbnail($post_id, $attachment_id); // Gán ảnh đại diện
                }
            }

            // Thông báo thành công
            $_SESSION['post_success'] = "Bài viết của bạn đã được gửi và đang chờ duyệt.";
            wp_redirect($_SERVER['REQUEST_URI']); // Làm mới trang
            exit;
        } else {
            $_SESSION['post_error'] = "Có lỗi xảy ra khi tạo bài viết!";
        }
    }
}
add_action('init', 'handle_post_submission');

// Hàm render form từ file form.php
function render_post_form() {
    ob_start();
    display_post_submission_messages(); // Hiển thị thông báo
    include 'E:\CSN_110122107\XAMPP\htdocs\110122107\wordpress\wp-content\themes\buddyx\form.php';
    return ob_get_clean();
}

// Hàm hiển thị thông báo lỗi và thành công
function display_post_submission_messages() {
    if (isset($_SESSION['post_success'])) {
        echo '<p style="color: green; font-weight: bold;">' . esc_html($_SESSION['post_success']) . '</p>';
        unset($_SESSION['post_success']);
    }
    if (isset($_SESSION['post_error'])) {
        echo '<p style="color: red; font-weight: bold;">' . esc_html($_SESSION['post_error']) . '</p>';
        unset($_SESSION['post_error']);
    }
}

// Đăng ký shortcode để hiển thị form
add_shortcode('post_submission_form', 'render_post_form');
